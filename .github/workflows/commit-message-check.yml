name: Check Commit Message

on: [push]

jobs:
  check-commit-message:
    runs-on: ubuntu-latest
    steps:
      - name: Check code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get pushed commits
        id: get_commits
        run: |
          commits=$(git log ${{ github.event.before }}..${{ github.event.after }} --pretty=format:'%s')
          echo "commits=$commits" >> $GITHUB_OUTPUT

      - name: Check commit messages
        run: |
          # Get base branch
          base_branch=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')

          echo "Base branch is $base_branch"

          # Get the commit list
          commits=$(git log origin/$base_branch..HEAD --pretty=format:'%s')

          echo "Commits: $commits"

          # Check if there are any commits
          if [ -z "$commits" ]; then
            echo "No new commits found"
            exit 0
          fi

          # Check every commit
          echo "$commits" | while read commit; do
            if echo "$commit" | grep -qE "^Merge branch"; then
              echo "Ignoring merge commit: $commit"
              continue
            fi

            if ! echo "$commit" | grep -qE "^[0-9]+: .+$"; then
              echo "Error: Commit message '$commit' does not match the required format '<issue number>: <commit message>'"
              exit 1
            fi
          done

          echo "All commit messages are in the correct format."
